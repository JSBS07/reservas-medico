<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>Lista de Reservas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
        <a class="navbar-brand" href="/">Clinica Medica</a>
        <div class="navbar-nav ms-auto">
            <span class="navbar-text me-3" sec:authentication="name"></span>
            <form th:action="@{/logout}" method="post" class="d-inline">
                <button type="submit" class="btn btn-outline-light btn-sm">Cerrar Sesion</button>
            </form>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <h1>Mis Reservas</h1>

    <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
    <div th:if="${warning}" class="alert alert-warning" th:text="${warning}"></div>
    <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

    <div class="mb-3">
        <a href="/reservas/nueva" class="btn btn-primary">Nueva Reserva</a>
        <a href="/dashboard" class="btn btn-secondary">Dashboard</a>
    </div>

    <div th:if="${reservas.empty}" class="alert alert-info">
        No hay reservas registradas.
    </div>

    <div th:unless="${reservas.empty}" class="table-responsive">
        <table class="table table-striped">
            <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>Paciente</th>
                <th>Telefono</th>
                <th>Fecha Nac.</th>
                <th>Doctor</th>
                <th>Servicio</th>
                <th>Duracion</th>
                <th>Fecha</th>
                <th>Hora</th>
                <th>Estado</th>
                <th>Acciones</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="reserva : ${reservas}">
                <td th:text="${reserva.id}"></td>
                <td th:text="${reserva.paciente.nombres} + ' ' + ${reserva.paciente.apellidos}"></td>
                <td th:text="${reserva.paciente.telefono} ?: 'No disponible'"></td>
                <td th:text="${#temporals.format(reserva.paciente.fechaNacimiento, 'dd/MM/yyyy')}"></td>
                <td th:text="${reserva.doctor.nombreCompleto}"></td>
                <td th:text="${reserva.servicio.nombreServicio}"></td>
                <td th:text="${reserva.servicio.duracionMinutos} + ' min'"></td>
                <td th:text="${#temporals.format(reserva.fechaReserva, 'dd/MM/yyyy')}"></td>
                <td th:text="${#temporals.format(reserva.horaReserva, 'HH:mm')}"></td>
                <td>
                    <span th:switch="${reserva.estado}">
                        <span th:case="'PENDIENTE'" class="badge bg-warning">PENDIENTE</span>
                        <span th:case="'CONFIRMADA'" class="badge bg-success">CONFIRMADA</span>
                        <span th:case="'CANCELADA'" class="badge bg-danger">CANCELADA</span>
                        <span th:case="*" class="badge bg-secondary" th:text="${reserva.estado}"></span>
                    </span>
                </td>
                <td>
                    <div th:if="${reserva.estado == 'PENDIENTE'}">
                        <form th:action="@{/reservas/cancelar/{id}(id=${reserva.id})}" method="post"
                              onsubmit="return confirm('Cancelar la reserva?');">
                            <button type="submit" class="btn btn-danger btn-sm">Cancelar</button>
                        </form>
                    </div>
                    <div th:if="${reserva.estado != 'PENDIENTE'}" class="text-muted">
                        <small>No cancelable</small>
                    </div>
                </td>
            </tr>
            </tbody>
        </table>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
