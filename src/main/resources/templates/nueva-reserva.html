<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendar Cita - MediCitas</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/reservas.css">
</head>
<body>
<header class="app-bar">
    <div class="app-bar__inner">
        <a class="brand" href="/">
            <span class="brand__icon"><i class="fas fa-staff-snake"></i></span>
            <span class="brand__name">MediCitas</span>
        </a>
        <div class="app-bar__actions">
            <span class="user-chip">
                <i class="fas fa-user-nurse"></i>
                <span sec:authentication="name"></span>
            </span>
            <form th:action="@{/logout}" method="post">
                <input type="hidden" th:if="${_csrf != null}"
                       th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                <button type="submit" class="btn btn-secondary">
                    <i class="fas fa-door-open"></i>
                    Cerrar sesion
                </button>
            </form>
        </div>
    </div>
</header>

<main>
    <div class="reservation-layout">
        <section class="info-panel">
            <div>
                <h1>Agenda tu proxima cita hospitalaria</h1>
                <p>
                    Selecciona al especialista, servicio y horario ideal. Nuestro equipo cuida cada detalle para que la experiencia sea segura y humana.
                </p>
            </div>
            <div class="info-highlights">
                <div class="highlight-card">
                    <div class="highlight-card__icon"><i class="fas fa-shield-heart"></i></div>
                    <div>
                        <strong>Protocolos certificados</strong>
                        <p>Seguimiento clinico y recordatorio de citas automatizado.</p>
                    </div>
                </div>
                <div class="highlight-card">
                    <div class="highlight-card__icon"><i class="fas fa-users-medical"></i></div>
                    <div>
                        <strong>Red de especialistas</strong>
                        <p>Profesionales con trayectoria en las principales instituciones hospitalarias.</p>
                    </div>
                </div>
                <div class="highlight-card">
                    <div class="highlight-card__icon"><i class="fas fa-laptop-medical"></i></div>
                    <div>
                        <strong>Gestion en tiempo real</strong>
                        <p>Actualiza tu agenda y controla disponibilidad en segundos.</p>
                    </div>
                </div>
            </div>
        </section>

        <section class="form-panel">
            <div class="form-header">
                <h2>Nueva reserva</h2>
                <p>Completa los datos solicitados. Todos los campos marcados con * son obligatorios.</p>
            </div>

            <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

            <form th:action="@{/reservas/crear}" th:object="${form}" method="post">
                <input type="hidden" th:if="${_csrf != null}"
                       th:name="${_csrf.parameterName}" th:value="${_csrf.token}">

                <div class="form-section">
                    <div class="form-section__title">
                        <i class="fas fa-id-card-clip"></i>
                        <span>Datos del paciente</span>
                    </div>
                    <div class="form-grid columns-2">
                        <div class="form-control-group">
                            <label for="nombresPaciente">Nombres *</label>
                            <input type="text" id="nombresPaciente" class="form-input"
                                   th:field="*{nombresPaciente}"
                                   pattern="^(?=.{2,60}$)(?!.*\\s{2})(?=.*[AEIOUaeiou\\u00C1\\u00C9\\u00CD\\u00D3\\u00DA\\u00E1\\u00E9\\u00ED\\u00F3\\u00FA\\u00D1\\u00F1])[A-Za-z\\u00C1\\u00C9\\u00CD\\u00D3\\u00DA\\u00E1\\u00E9\\u00ED\\u00F3\\u00FA\\u00D1\\u00F1'\\-]+(?:\\s[A-Za-z\\u00C1\\u00C9\\u00CD\\u00D3\\u00DA\\u00E1\\u00E9\\u00ED\\u00F3\\u00FA\\u00D1\\u00F1'\\-]+){0,3}$"
                                   autocomplete="name"
                                   th:readonly="${usuarioActual != null and usuarioActual.paciente != null}"
                                   th:classappend="${#fields.hasErrors('nombresPaciente')} ? ' is-invalid'">
                            <div class="invalid-feedback"
                                 th:if="${#fields.hasErrors('nombresPaciente')}"
                                 th:errors="*{nombresPaciente}">Error</div>
                        </div>
                        <div class="form-control-group">
                            <label for="apellidosPaciente">Apellidos *</label>
                            <input type="text" id="apellidosPaciente" class="form-input"
                                   th:field="*{apellidosPaciente}"
                                   pattern="^(?=.{2,60}$)(?!.*\\s{2})(?=.*[AEIOUaeiou\\u00C1\\u00C9\\u00CD\\u00D3\\u00DA\\u00E1\\u00E9\\u00ED\\u00F3\\u00FA\\u00D1\\u00F1])[A-Za-z\\u00C1\\u00C9\\u00CD\\u00D3\\u00DA\\u00E1\\u00E9\\u00ED\\u00F3\\u00FA\\u00D1\\u00F1'\\-]+(?:\\s[A-Za-z\\u00C1\\u00C9\\u00CD\\u00D3\\u00DA\\u00E1\\u00E9\\u00ED\\u00F3\\u00FA\\u00D1\\u00F1'\\-]+){0,3}$"
                                   autocomplete="family-name"
                                   th:readonly="${usuarioActual != null and usuarioActual.paciente != null}"
                                   th:classappend="${#fields.hasErrors('apellidosPaciente')} ? ' is-invalid'">
                            <div class="invalid-feedback"
                                 th:if="${#fields.hasErrors('apellidosPaciente')}"
                                 th:errors="*{apellidosPaciente}">Error</div>
                        </div>
                    </div>

                    <div class="form-grid columns-2" style="margin-top: 1rem;">
                        <div class="form-control-group">
                            <label for="telefonoPaciente">Telefono *</label>
                            <input type="tel" id="telefonoPaciente" class="form-input"
                                   th:field="*{telefonoPaciente}"
                                   placeholder="+57 300 123 4567"
                                   pattern="^(?:\+57)?3[0-9]{9}$" inputmode="numeric" autocomplete="tel"
                                   title="Formato esperado: +57 opcional seguido de un numero movil de 10 digitos que inicia en 3"
                                   th:classappend="${#fields.hasErrors('telefonoPaciente')} ? ' is-invalid'">
                            <div class="invalid-feedback"
                                 th:if="${#fields.hasErrors('telefonoPaciente')}"
                                 th:errors="*{telefonoPaciente}">Error</div>
                        </div>
                        <div class="form-control-group">
                            <label for="fechaNacimientoPaciente">Fecha de nacimiento *</label>
                            <input type="date" id="fechaNacimientoPaciente" class="form-input"
                                   name="fechaNacimientoPaciente"
                                   th:value="${form.fechaNacimientoPaciente != null ? #temporals.format(form.fechaNacimientoPaciente, 'yyyy-MM-dd') : (usuarioActual != null and usuarioActual.paciente != null and usuarioActual.paciente.fechaNacimiento != null ? #temporals.format(usuarioActual.paciente.fechaNacimiento, 'yyyy-MM-dd') : '')}"
                                   th:readonly="${usuarioActual != null and usuarioActual.paciente != null and usuarioActual.paciente.fechaNacimiento != null}"
                                   th:classappend="${#fields.hasErrors('fechaNacimientoPaciente')} ? ' is-invalid'">
                            <div class="invalid-feedback"
                                 th:if="${#fields.hasErrors('fechaNacimientoPaciente')}"
                                 th:errors="*{fechaNacimientoPaciente}">Error</div>
                        </div>
                    </div>

                    <div class="form-control-group" style="margin-top: 0.5rem;" th:if="${usuarioActual != null and usuarioActual.paciente != null}">
                        <label class="checkbox">
                            <input type="checkbox" th:field="*{actualizarDatosPaciente}">
                            <span>Actualizar mi telefono</span>
                        </label>
                        <small class="form-help">Actualiza los datos del paciente con lo que ingreses aquí.</small>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section__title">
                        <i class="fas fa-calendar-check"></i>
                        <span>Detalles de la cita</span>
                    </div>
                    <div class="form-grid columns-2">
                        <div class="form-control-group">
                            <label for="doctorId">Doctor *</label>
                            <select id="doctorId" class="form-input"
                                    th:field="*{doctorId}"
                                    th:classappend="${#fields.hasErrors('doctorId')} ? ' is-invalid'">
                                <option value="" disabled th:selected="*{doctorId} == null">Seleccionar doctor...</option>
                                <option th:each="doctor : ${doctores}"
                                        th:value="${doctor.id}"
                                        th:data-telefono="${doctor.telefono != null ? doctor.telefono : 'No disponible'}"
                                        th:text="${doctor.nombreCompleto}"></option>
                            </select>
                            <div class="invalid-feedback"
                                 th:if="${#fields.hasErrors('doctorId')}"
                                 th:errors="*{doctorId}">Error</div>
                        </div>
                        <div class="form-control-group">
                            <label for="doctorTelefono">Contacto del doctor</label>
                            <input type="text" id="doctorTelefono" class="form-input" value="No disponible" readonly>
                        </div>
                    </div>

                    <div class="form-grid columns-2" style="margin-top: 1rem;">
                        <div class="form-control-group">
                            <label for="servicioId">Servicio medico *</label>
                            <select id="servicioId" class="form-input"
                                    th:field="*{servicioId}"
                                    th:classappend="${#fields.hasErrors('servicioId')} ? ' is-invalid'">
                                <option value="" disabled th:selected="*{servicioId} == null">Seleccionar servicio...</option>
                                <option th:each="servicio : ${servicios}"
                                        th:value="${servicio.id}"
                                        th:data-duracion="${servicio.duracionMinutos}"
                                        th:text="${servicio.nombreServicio}"></option>
                            </select>
                            <div class="invalid-feedback"
                                 th:if="${#fields.hasErrors('servicioId')}"
                                 th:errors="*{servicioId}">Error</div>
                        </div>
                        <div class="form-control-group">
                            <label for="duracionServicio">Duracion del servicio</label>
                            <input type="text" id="duracionServicio" class="form-input" placeholder="Seleccione un servicio" readonly>
                        </div>
                    </div>

                    <div class="form-grid columns-2" style="margin-top: 1rem;">
                        <div class="form-control-group">
                            <label for="fechaReserva">Fecha *</label>
                            <input type="date" id="fechaReserva" class="form-input"
                                   th:field="*{fechaReserva}"
                                   th:classappend="${#fields.hasErrors('fechaReserva')} ? ' is-invalid'">
                            <div class="invalid-feedback"
                                 th:if="${#fields.hasErrors('fechaReserva')}"
                                 th:errors="*{fechaReserva}">Error</div>
                        </div>
                        <div class="form-control-group">
                            <label for="horaReserva">Hora *</label>
                            <input type="time" id="horaReserva" class="form-input"
                                   th:field="*{horaReserva}"
                                   min="07:00" max="17:00" step="1800"
                                   th:classappend="${#fields.hasErrors('horaReserva')} ? ' is-invalid'">
                            <div class="invalid-feedback"
                                 th:if="${#fields.hasErrors('horaReserva')}"
                                 th:errors="*{horaReserva}">Error</div>
                        </div>
                    </div>
                </div>

                <div class="alert alert-danger" th:if="${#fields.hasGlobalErrors()}" th:each="e : ${#fields.globalErrors()}" th:text="${e}">Error global</div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-calendar-plus"></i>
                        Agendar cita
                    </button>
                    <a th:href="@{/reservas/listar}" class="btn btn-secondary">
                        <i class="fas fa-list"></i>
                        Ver reservas
                    </a>
                </div>
            </form>
        </section>
    </div>
</main>

<script th:inline="javascript">
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, '0');
    const dd = String(today.getDate()).padStart(2, '0');
    const todayStr = `${yyyy}-${mm}-${dd}`;

    const fechaReservaInput = document.getElementById('fechaReserva');
    if (fechaReservaInput) {
        fechaReservaInput.min = todayStr;
        const maxDate = new Date(today);
        maxDate.setMonth(maxDate.getMonth() + 2);
        const maxY = maxDate.getFullYear();
        const maxM = String(maxDate.getMonth() + 1).padStart(2, '0');
        const maxD = String(maxDate.getDate()).padStart(2, '0');
        const maxStr = `${maxY}-${maxM}-${maxD}`;
        fechaReservaInput.max = maxStr;
    }

    const fechaNacInput = document.getElementById('fechaNacimientoPaciente');
    if (fechaNacInput) {
        const minDob = new Date(yyyy - 95, today.getMonth(), today.getDate());
        const maxDob = new Date(yyyy - 15, today.getMonth(), today.getDate());
        const toStr = (d) => `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
        fechaNacInput.min = toStr(minDob);
        fechaNacInput.max = toStr(maxDob);
    }

    const doctorSelect = document.getElementById('doctorId');
    const doctorTelefono = document.getElementById('doctorTelefono');
    if (doctorSelect && doctorTelefono) {
        const updateDoctorTel = () => {
            const opt = doctorSelect.options[doctorSelect.selectedIndex];
            const tel = opt && opt.getAttribute('data-telefono');
            doctorTelefono.value = (doctorSelect.value && tel) ? tel : 'No disponible';
        };
        doctorSelect.addEventListener('change', updateDoctorTel);
        updateDoctorTel();
    }

    const servicioSelect = document.getElementById('servicioId');
    const duracionServicio = document.getElementById('duracionServicio');
    if (servicioSelect && duracionServicio) {
        const updateDuracion = () => {
            const opt = servicioSelect.options[servicioSelect.selectedIndex];
            const dur = opt && opt.getAttribute('data-duracion');
            duracionServicio.value = (servicioSelect.value && dur) ? `${dur} minutos` : 'No disponible';
        };
        servicioSelect.addEventListener('change', updateDuracion);
        updateDuracion();
    }

    // ===== Validaciones en tiempo real =====
    const nombresInput = document.getElementById('nombresPaciente');
    const apellidosInput = document.getElementById('apellidosPaciente');
    const telefonoInput = document.getElementById('telefonoPaciente');
    const horaInput = document.getElementById('horaReserva');

    const festivosConfig = /*[[${@environment.getProperty('reservas.festivos') ?: ''}]]*/ '';
    const festivos = (festivosConfig || '')
        .split(',')
        .map(s => s.trim())
        .filter(Boolean);
    const festivosFijos = new Set(festivos.filter(s => /^\d{4}-\d{2}-\d{2}$/.test(s)));
    const festivosRecurrentes = new Set(festivos.filter(s => /^\d{2}-\d{2}$/.test(s)));

    const PERMITTED_WORD = /^[A-Za-zÁÉÍÓÚáéíóúÑñ'\-]+$/;
    const VOWEL = /[AEIOUÁÉÍÓÚaeiouáéíóú]/;
    const LAUGH = /(ja|je|ji|jo|ju){2,}/i;
    const BLOCKED = new Set(['paciente','anonimo','anónimo','test','prueba','jaja','jeje','jiji','jojo','jajaja','jejeje','jijiji','xd','asdf','qwerty']);

    function normalizeSpaces(s){ return (s || '').trim().replace(/\s+/g, ' '); }
    function removeDiacritics(s){ return s.normalize('NFD').replace(/\p{M}/gu,''); }
    function cmpToken(s){ return removeDiacritics(s).toLowerCase().replace(/'/g,''); }

    function hasExcessiveRepeats(word, max=3){
        let count = 1;
        for (let i=1;i<word.length;i++){
            if (word[i].toLowerCase() === word[i-1].toLowerCase()){
                if (++count>max) return true;
            } else count=1;
        }
        return false;
    }

    function validateNombre(value, {allowRepeatedWords=false}={}){
        const errors = [];
        const s = normalizeSpaces(value);
        if (!s) return errors; // requerido lo maneja servidor/HTML
        if (s.length < 2 || s.length > 60) errors.push('Debe tener entre 2 y 60 caracteres.');
        const words = s.split(' ');
        if (words.length > 4) errors.push('Maximo 4 palabras.');
        const seen = new Set();
        for (const w of words){
            if (!w) { errors.push('Formato invalido.'); continue; }
            const cmp = cmpToken(w);
            if (!allowRepeatedWords && seen.has(cmp)) errors.push('No repitas palabras.');
            seen.add(cmp);
            if (BLOCKED.has(cmp)) errors.push('Palabra no permitida.');
            if (w.length < 2 || w.length > 30) errors.push('Cada palabra entre 2 y 30 caracteres.');
            if (!PERMITTED_WORD.test(w)) errors.push('Solo letras, guion o apostrofe.');
            if (!VOWEL.test(w)) errors.push('Cada palabra debe contener una vocal.');
            if (LAUGH.test(w)) errors.push('Evita cadenas tipo "jaja".');
            if (hasExcessiveRepeats(w)) errors.push('Evita caracteres repetidos en exceso.');
        }
        return [...new Set(errors)];
    }

    function validateTelefono(value){
        const s = (value || '').replace(/[\s\-()]/g,'');
        let digits = s.startsWith('+57') ? s.slice(3) : s;
        if (/^3\d{9}$/.test(digits)) return [];
        if (/^60[1-8]\d{7}$/.test(digits)) return [];
        return ['Ingrese un telefono colombiano valido (+57 opcional).'];
    }

    function isWeekend(date){ const d=date.getDay(); return d===0 || d===6; }
    function toYMD(date){ const y=date.getFullYear(); const m=String(date.getMonth()+1).padStart(2,'0'); const d=String(date.getDate()).padStart(2,'0'); return `${y}-${m}-${d}`; }
    function isHoliday(date){
        const ymd = toYMD(date);
        const md = ymd.slice(5);
        return festivosFijos.has(ymd) || festivosRecurrentes.has(md);
    }

    function setFieldError(inputEl, msg){
        const group = inputEl.closest('.form-control-group') || inputEl.parentElement;
        let err = group.querySelector('.client-error');
        if (!err){
            err = document.createElement('div');
            err.className = 'invalid-feedback client-error';
            group.appendChild(err);
        }
        if (msg){
            inputEl.classList.add('is-invalid');
            err.textContent = msg;
            err.style.display = '';
        } else {
            inputEl.classList.remove('is-invalid');
            err.textContent = '';
            err.style.display = 'none';
        }
    }

    function validateAll(){
        let firstInvalid = null;

        // Nombres
        if (nombresInput){
            const errs = validateNombre(nombresInput.value, {allowRepeatedWords:false});
            setFieldError(nombresInput, errs[0]);
            if (errs.length && !firstInvalid) firstInvalid = nombresInput;
        }

        // Apellidos
        if (apellidosInput){
            const errs = validateNombre(apellidosInput.value, {allowRepeatedWords:true});
            setFieldError(apellidosInput, errs[0]);
            if (errs.length && !firstInvalid) firstInvalid = apellidosInput;
        }

        // Nombres y apellidos no iguales
        if (nombresInput && apellidosInput){
            const a = normalizeSpaces(nombresInput.value).toLowerCase();
            const b = normalizeSpaces(apellidosInput.value).toLowerCase();
            if (a && b && a === b){
                setFieldError(apellidosInput, 'Nombres y apellidos no pueden ser iguales.');
                if (!firstInvalid) firstInvalid = apellidosInput;
            }
        }

        // Telefono
        if (telefonoInput){
            const errs = validateTelefono(telefonoInput.value);
            setFieldError(telefonoInput, errs[0]);
            if (errs.length && !firstInvalid) firstInvalid = telefonoInput;
        }

        // Fecha de nacimiento (15..95 años)
        if (fechaNacInput){
            const val = fechaNacInput.value;
            let msg = '';
            if (val){
                const d = new Date(val+'T00:00:00');
                const now = new Date();
                const y = now.getFullYear();
                const minDob = new Date(y - 95, now.getMonth(), now.getDate());
                const maxDob = new Date(y - 15, now.getMonth(), now.getDate());
                if (d < minDob || d > maxDob) msg = 'Edad permitida: entre 15 y 95 años.';
            }
            setFieldError(fechaNacInput, msg || null);
            if (msg && !firstInvalid) firstInvalid = fechaNacInput;
        }

        // Fecha de reserva: fin de semana/festivo
        if (fechaReservaInput){
            const val = fechaReservaInput.value;
            let msg = '';
            if (val){
                const d = new Date(val+'T00:00:00');
                if (isWeekend(d)) msg = 'No se pueden agendar citas los fines de semana.';
                else if (isHoliday(d)) msg = 'No se pueden agendar citas en días festivos.';
            }
            setFieldError(fechaReservaInput, msg || null);
            if (msg && !firstInvalid) firstInvalid = fechaReservaInput;
        }

        // Hora de reserva: 07:00..17:00
        if (horaInput){
            const val = horaInput.value;
            let msg = '';
            if (val){
                const [h,m] = val.split(':').map(Number);
                const t = h + (m/60);
                if (t < 7 || t > 17) msg = 'La hora debe estar entre 7:00 y 17:00.';
            }
            setFieldError(horaInput, msg || null);
            if (msg && !firstInvalid) firstInvalid = horaInput;
        }

        return firstInvalid;
    }

    // Bind events
    [nombresInput, apellidosInput, telefonoInput, fechaNacInput, fechaReservaInput, horaInput]
        .filter(Boolean)
        .forEach(el => el.addEventListener('input', () => validateAll()));

    // Validate on submit
    const form = document.querySelector('form[th\\:action], form[action*="/reservas/crear"]') || document.querySelector('form');
    if (form){
        form.addEventListener('submit', (e) => {
            const firstInvalid = validateAll();
            if (firstInvalid){
                e.preventDefault();
                firstInvalid.focus();
            }
        });
    }

    // ===== Guardado automático (no perder datos) =====
    const DRAFT_KEY = 'reservaFormDraft';
    function readDraft(){
        try { return JSON.parse(localStorage.getItem(DRAFT_KEY) || '{}'); } catch(_) { return {}; }
    }
    function writeDraft(obj){
        try { localStorage.setItem(DRAFT_KEY, JSON.stringify(obj)); } catch(_) {}
    }
    function collect(){
        return {
            nombresPaciente: nombresInput?.value || '',
            apellidosPaciente: apellidosInput?.value || '',
            telefonoPaciente: telefonoInput?.value || '',
            fechaNacimientoPaciente: fechaNacInput?.value || '',
            doctorId: document.getElementById('doctorId')?.value || '',
            servicioId: servicioSelect?.value || '',
            fechaReserva: fechaReservaInput?.value || '',
            horaReserva: horaInput?.value || '',
            actualizarDatosPaciente: (document.getElementById('actualizarDatosPaciente')?.checked) || false,
        };
    }
    function restore(){
        const d = readDraft();
        const setIfEmpty = (el, val) => { if (el && !el.value) el.value = val || ''; };
        setIfEmpty(nombresInput, d.nombresPaciente);
        setIfEmpty(apellidosInput, d.apellidosPaciente);
        setIfEmpty(telefonoInput, d.telefonoPaciente);
        setIfEmpty(fechaNacInput, d.fechaNacimientoPaciente);
        const doctorSelectEl = document.getElementById('doctorId');
        if (doctorSelectEl && !doctorSelectEl.value && d.doctorId){ doctorSelectEl.value = String(d.doctorId); doctorSelectEl.dispatchEvent(new Event('change')); }
        if (servicioSelect && !servicioSelect.value && d.servicioId){ servicioSelect.value = String(d.servicioId); servicioSelect.dispatchEvent(new Event('change')); }
        setIfEmpty(fechaReservaInput, d.fechaReserva);
        setIfEmpty(horaInput, d.horaReserva);
        const ck = document.getElementById('actualizarDatosPaciente');
        if (ck && typeof d.actualizarDatosPaciente === 'boolean') ck.checked = d.actualizarDatosPaciente;
    }
    function startAutosave(){
        const fields = [nombresInput, apellidosInput, telefonoInput, fechaNacInput, fechaReservaInput, horaInput, document.getElementById('doctorId'), servicioSelect, document.getElementById('actualizarDatosPaciente')].filter(Boolean);
        fields.forEach(el => el.addEventListener('input', () => writeDraft(collect())));
        fields.forEach(el => el.addEventListener('change', () => writeDraft(collect())));
        // guarda inmediatamente el estado inicial
        writeDraft(collect());
    }
    restore();
    startAutosave();
</script>
</body>
</html>
